#!/bin/bash
#
#   Copyright 2020 binx.io B.V.
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
echo "INFO: about to nuke $ACCOUNT_ID"
aws sts get-session-token \
  --output text \
  --query 'join(` `, [
    `aws configure --profile aws-account-destroyer set aws_access_key_id `,
    Credentials.AccessKeyId,
    `\naws configure --profile aws-account-destroyer set aws_secret_access_key `,
    Credentials.SecretAccessKey,
    `\naws configure --profile aws-account-destroyer set aws_session_token `,
    Credentials.SessionToken, `\n`])' | bash
echo "INFO: profile set"
if ! which aws-nuke; then
	echo "INFO: downloading aws-nuke"
	curl -sS -L -o /usr/local/bin/aws-nuke https://github.com/rebuy-de/aws-nuke/releases/download/v2.14.0/aws-nuke-v2.14.0-linux-amd64
	chmod +x /usr/local/bin/aws-nuke
	export PATH=$PATH:/usr/local/bin
fi
sed -e "s/{{ACCOUNT_ID}}/$ACCOUNT_ID/g" aws-nuke.yaml.template > aws-nuke.yaml
aws-nuke --config aws-nuke.yaml --force-sleep 60 --profile aws-account-destroyer $@
